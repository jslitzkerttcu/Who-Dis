{% extends "base.html" %}

{% block title %}Database Management - Who Dis?{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h1 class="mb-4 text-center"><i class="bi bi-database-fill-gear"></i> Database Management</h1>

        <div class="alert alert-info shadow-sm" role="alert">
            <h5 class="alert-heading">Database Overview</h5>
            <p>Monitor health, manage caches, and keep the data flowing smoothly.</p>
        </div>

        <!-- Database Health Card -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> Database Health</h5>
            </div>
            <div class="card-body">
                <div id="db-health-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="db-health-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h2 id="db-status-icon" class="mb-2"></h2>
                                <h6>Status</h6>
                                <p id="db-status" class="mb-0"></p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h2 class="text-primary mb-2" id="db-size">--</h2>
                                <h6>Database Size</h6>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h2 class="text-info mb-2" id="active-connections">--</h2>
                                <h6>Active Connections</h6>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h2 class="text-warning mb-2" id="pool-usage">--</h2>
                                <h6>Pool Usage</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <!-- Error Logs -->
            <div class="col-md-6 mb-3">
                <div class="card border-danger h-100">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Error Logs</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">View recent application errors and exceptions.</p>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Recent Errors: <span id="error-count" class="badge bg-danger">0</span></span>
                            <span>Last 24h: <span id="error-24h" class="badge bg-warning">0</span></span>
                        </div>
                        <button class="btn btn-outline-danger w-100" disabled title="Feature coming soon">
                            <i class="bi bi-journal-x"></i> View Error Logs
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cache Management -->
            <div class="col-md-6 mb-3">
                <div class="card border-info h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Cache Management</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Manage search and API caches for optimal performance.</p>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Search Cache:</span>
                                <span id="search-cache-size" class="badge bg-secondary">0 entries</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Genesys Token:</span>
                                <span id="genesys-cache-status" class="badge bg-secondary">Unknown</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Graph API Token:</span>
                                <span id="graph-cache-status" class="badge bg-secondary">Unknown</span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Genesys Groups:</span>
                                <span id="genesys-groups-count" class="badge bg-info">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Genesys Locations:</span>
                                <span id="genesys-locations-count" class="badge bg-info">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Cache Age:</span>
                                <span id="genesys-cache-age" class="text-muted small">Unknown</span>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" data-action="refresh-genesys-cache" aria-label="Refresh Genesys cache">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Genesys Cache
                            </button>
                            <button class="btn btn-outline-info" data-action="clear-caches" aria-label="Clear all caches">
                                <i class="bi bi-trash"></i> Clear All Caches
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Management -->
            <div class="col-md-6 mb-3">
                <div class="card border-success h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Active Sessions</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Monitor and manage user sessions.</p>
                        <div class="text-center mb-3">
                            <h3 id="active-sessions" class="text-success">0</h3>
                            <small class="text-muted">Active Users</small>
                        </div>
                        <button class="btn btn-outline-success w-100" disabled title="Feature coming soon">
                            <i class="bi bi-person-lines-fill"></i> Manage Sessions
                        </button>
                    </div>
                </div>
            </div>

            <!-- Maintenance -->
            <div class="col-md-6 mb-3">
                <div class="card border-warning h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-tools"></i> Maintenance</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Database maintenance and optimization tools.</p>
                        <button class="btn btn-outline-warning w-100 mb-2" data-action="export-audit-logs" aria-label="Export audit logs">
                            <i class="bi bi-download"></i> Export Audit Logs
                        </button>
                        <button class="btn btn-outline-warning w-100" data-action="optimize-database" aria-label="Optimize database tables">
                            <i class="bi bi-speedometer2"></i> Optimize Tables
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Table Statistics Accordion (at bottom) -->
        <div class="accordion mb-4" id="tableStatsAccordion">
            <div class="accordion-item border-dark">
                <h2 class="accordion-header" id="tableStatsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#tableStatsCollapse" aria-expanded="false" 
                            aria-controls="tableStatsCollapse">
                        <i class="bi bi-table me-2"></i> Table Statistics
                    </button>
                </h2>
                <div id="tableStatsCollapse" class="accordion-collapse collapse" 
                     aria-labelledby="tableStatsHeading" data-bs-parent="#tableStatsAccordion">
                    <div class="accordion-body">
                        <div id="table-stats-loading" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="table-stats-content" style="display: none;">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Table</th>
                                        <th>Row Count</th>
                                        <th>Size</th>
                                        <th>Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody id="table-stats-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/shared-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-database.js') }}"></script>
{% endblock %}